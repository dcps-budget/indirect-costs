---
title: "Clean Non-Personnel"
format: html
---

```{r}
library(tidyverse)
library(glue)
library(janitor)
library(readxl)
library(writexl)

options(scipen = 12, digits = 12)
```

Setup

```{r}
path_data <- glue(
  "C:/Users",
  "{Sys.getenv('USERNAME')}",
  "OneDrive - District of Columbia Public Schools",
  "Data",
  .sep = "/"
)

path_working <- glue(
  "C:/Users",
  "{Sys.getenv('USERNAME')}",
  "OneDrive - District of Columbia Public Schools",
  "Working Files - Indirect Cost",
  .sep = "/"
)

fy <- "2024"

dir_r051a <- glue("{path_data}/Journal Entries/R051A/raw/{fy}")

path_r209 <-
  glue("{path_data}/Budget/R209/raw/{fy}/r209_GD0_GA0_{fy}.xlsx")

path_r051a_ga0 <-
  glue("{dir_r051a}/r051a_expense_71_GA0_{fy}.xlsx")

path_r051a_gd0 <-
  glue("{dir_r051a}/r051a_expense_71_GD0_{fy}.xlsx")
```

```{r}
costcenters <-
  read_excel(
    glue(
      "{path_working}/Categorization by Cost Center, Program 2, Program.xlsx"
    ),
    col_types = "text"
  ) %>%
  clean_names() %>%
  mutate(
    costcenter_clean = if_else(
      !is.na(costcenter_name_clean), costcenter_name_clean, costcenter
    ),
    costcenter_name_clean = if_else(
      !is.na(costcenter_name_clean), costcenter_name_clean, costcenter_name
    )
  ) %>%
  distinct(costcenter, costcenter_clean, costcenter_name_clean)
```

Read programs

```{r}
programs <- read_excel("data/programs.xlsx")
```

Read R209

```{r}
r209_raw <-
  read_excel(path_r209, col_types = "text", range = "A17:AG5216") %>%
  clean_names()

r209 <- r209_raw
```

Read R051A

```{r}
r051a_ga0 <-
  read_excel(path_r051a_ga0, col_types = "text", range = "A12:AT66121") %>%
  clean_names()

r051a_gd0 <-
  read_excel(path_r051a_gd0, col_types = "text", range = "A12:AT69603") %>%
  clean_names()

r051a_raw <- bind_rows(r051a_ga0, r051a_gd0)

r051a <- r051a_raw
```

Rename

```{r}
r051a_rename <-
  r051a %>%
  rename(
    costcenter = cost_center
  )
```

Clean and transform

```{r}
r051a_clean <-
  r051a_rename %>%
  filter(agency == "GA0" | (project %in% r209$project)) %>%
  mutate(across(net_accounted, \(x) round(as.numeric(x), 2))) %>%
  mutate(across(party_name, \(x) str_to_upper(str_squish(x)))) %>%
  mutate(po_number = str_extract(
    transaction_id, regex("PO[:digit:]{6}", ignore_case = FALSE)
  )) %>%
  mutate(is_po = !is.na(po_number)) %>%
  mutate(is_service = str_detect(account_parent_1, "^713[12]"))
```

Join programs

```{r}
r051a_aug <-
  r051a_clean %>%
  left_join(costcenters, by = join_by(costcenter)) %>%
  left_join(programs, by = join_by(program))
```

```{r}
pos_dedupe <-
  r051a_aug %>%
  filter(is_po) %>%
  group_by(
    po_number,
    costcenter_name_clean, costcenter_clean,
    account, account_desc,
    is_service, party_name
  ) %>%
  summarize(net_accounted = sum(net_accounted)) %>%
  filter(net_accounted != 0.00) %>%
  group_by(po_number) %>%
  slice_max(order_by = net_accounted, n = 1) %>%
  slice_max(order_by = costcenter_clean, n = 1) %>%
  slice_max(order_by = account, n = 1) %>%
  ungroup() %>%
  distinct(
    po_is_service = is_service,
    po_costcenter_name = costcenter_name_clean,
    po_account_name = account_desc,
    po_vendor = party_name,
    po_costcenter = costcenter_clean,
    po_account = account,
    po_number,
  ) %>%
  arrange(
    desc(po_is_service),
    po_costcenter_name, po_account_name, po_vendor, po_number
  )

pos_dedupe
```

```{r}
# r051a_po <-
#   r051a_clean %>%
#   filter(is_po, is_service) %>%
#   select(
#     program_parent_level_2_description, cost_center_desc,
#     party_name, account_desc, po_number
#   ) %>%
#   arrange(
#     program_parent_level_2_description, cost_center_desc,
#     party_name, account_desc, po_number
#   )
```

Account categories

```{r}
# account_categories <-
#   r051a_clean %>%
#   count(account_desc, account)
```

Write

```{r}
# r051a_clean %>% write_xlsx("data/r051a_clean.xlsx")
#
# r051a_po %>% write_xlsx("data/r051a_po.xlsx")
#
# account_categories %>% write_xlsx("data/account_categories.xlsx")
```
